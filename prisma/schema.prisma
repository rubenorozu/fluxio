generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  isActive        Boolean  @default(true)
  
  // Subscription Plan
  plan            String   @default("BASIC") // TRIAL, BASIC, PROFESSIONAL, ENTERPRISE
  maxUsers        Int      @default(100) // User limit based on plan
  maxResources    Int      @default(50) // Resource limit (spaces + equipment)
  maxStorage      Int      @default(10) // Storage in GB

  // Trial plan fields
  trialDays       Int?     @default(7) // Days of trial period
  trialExpiresAt  DateTime? // When trial expires
  
  // Custom Domain fields
  customDomain    String?  @unique // Custom domain (e.g., universidad.com)
  domainStatus    DomainStatus @default(NOT_CONFIGURED)
  domainVerifiedAt DateTime?
  sslEnabled      Boolean  @default(false)
  
  users           User[]
  spaces          Space[]
  equipment       Equipment[]
  workshops       Workshop[]
  reservations    Reservation[]
  projects        Project[]
  reports         Report[]
  recurringBlocks RecurringBlock[]
  inscriptions    Inscription[]
  reservationCounters ReservationCounter[]
  reportCounters      ReportCounter[]
  config              TenantConfig?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([slug])
  @@index([customDomain])
}

model TenantConfig {
  id              String   @id @default(cuid())
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  tenantId        String   @unique
  
  topLogoUrl      String?
  topLogoHeight   Int?     @default(50) // Default height 50px
  bottomLogoUrl   String?
  faviconUrl      String?  // New field
  primaryColor    String?  @default("#145775") // Default blue
  secondaryColor  String?  @default("#1F2937") // Default dark gray
  tertiaryColor   String?  @default("#ff9500") // Default orange (Action color)
  inscriptionDefaultColor  String? @default("#ff9500") // Orange for default inscription button
  inscriptionPendingColor  String? @default("#ff9500") // Orange for pending inscriptions
  inscriptionApprovedColor String? @default("#28A745") // Success green for approved inscriptions
  pdfTopLogoUrl   String?  // URL for PDF top logo (PNG)
  pdfBottomLogoUrl String? // URL for PDF bottom logo (PNG)
  siteName        String?
  contactEmail    String?
  allowedDomains  String?  // Comma separated list of allowed domains
  privacyPolicy   String?  // HTML or Markdown content
  howItWorks      String?  // JSON string storing steps
  regulationsUrl  String?  // URL for regulations PDF
  attachmentFormUrl String? // URL for attachment form PDF
  
  // Landing page configuration
  landingContactEmail         String?  @default("contacto@fluxiorsv.com")
  landingDemoTrialDays        Int?     @default(7)
  landingFormFields           Json?
  landingAutoResponse         Boolean? @default(true)
  landingAutoResponseMessage  String?  @default("Gracias por tu inter√©s en Fluxio RSV.")
  
  // Home page carousel configuration
  carouselResourceLimit       Int?     @default(15) // Number of resources to show per type in carousel
  
  // Reservation form configuration
  reservationFormConfig       Json?    // Custom configuration for reservation form fields
  
  // Pricing plans configuration (for platform tenant landing page)
  pricingPlans                Json?    // Array of pricing plans with features
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model User {
  id                 String    @id @default(cuid())
  displayId          String?
  email              String
  firstName          String
  lastName           String
  password           String
  identifier         String
  phoneNumber        String?
  alternativeEmail   String?
  profileImageUrl    String?
  role               Role      @default(USER)
  isVerified         Boolean   @default(false)
  verificationToken  String?   @unique
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  reservations       Reservation[]
  inscriptions       Inscription[]
  notifications      Notification[]
  managedSpaces      Space[]
  managedEquipment   Equipment[]
  managedWorkshops   Workshop[]
  projects           Project[]
  approvedReservations Reservation[] @relation("ApprovedReservations")
  checkedOutReservations Reservation[] @relation("CheckedOutReservations")
  checkedInReservations  Reservation[] @relation("CheckedInReservations")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  reports            Report[]
  comments           Comment[]
  
  @@unique([email, tenantId])
  @@unique([identifier, tenantId])
  @@unique([displayId, tenantId])
  @@index([tenantId])
}

enum Role {
  USER
  ADMIN_RESOURCE
  ADMIN_RESERVATION
  SUPERUSER
  VIGILANCIA
  CALENDAR_VIEWER
}

model Space {
  id           String        @id @default(cuid())
  displayId    String?       @unique
  name         String
  description  String?
  images       Image[]
  status       ResourceStatus @default(AVAILABLE)
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  responsibleUserId String?
  responsibleUser   User?         @relation(fields: [responsibleUserId], references: [id])
  requiresSpaceReservationWithEquipment Boolean @default(false)
  reservationLeadTime Int?
  reservations Reservation[]
  equipments   Equipment[]
  recurringBlocks RecurringBlock[]
  requirements Requirement[] @relation("SpaceRequirements")
  reports      Report[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  @@index([tenantId])
}

model Image {
  id          String    @id @default(cuid())
  url         String
  space       Space?    @relation(fields: [spaceId], references: [id])
  spaceId     String?
  equipment   Equipment? @relation(fields: [equipmentId], references: [id])
  equipmentId String?
  workshop    Workshop? @relation(fields: [workshopId], references: [id])
  workshopId  String?
}

model Equipment {
  id           String        @id @default(cuid())
  displayId    String?       @unique
  name         String
  description  String?
  serialNumber String?
  fixedAssetId String?
  images       Image[]
  status       ResourceStatus @default(AVAILABLE)
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  spaceId      String?   @map("space_id")
  space        Space?    @relation(fields: [spaceId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  responsibleUserId String?
  responsibleUser   User?         @relation(fields: [responsibleUserId], references: [id])
  reservationLeadTime Int?
  isFixedToSpace    Boolean @default(false)
  reservations      Reservation[]
  recurringBlocks   RecurringBlockOnEquipment[]
  reports      Report[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  @@index([tenantId])
}

model Workshop {
  id                String        @id @default(cuid())
  displayId         String?       @unique
  name              String
  description       String?
  capacity          Int           @default(0)
  availableFrom     DateTime?
  inscriptionsOpen  Boolean       @default(true)
  inscriptionsStartDate DateTime?
  teacher           String?
  schedule          String?
  room              String?
  startDate         DateTime?
  endDate           DateTime?
  images            Image[]
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  responsibleUserId String?
  responsibleUser   User?         @relation(fields: [responsibleUserId], references: [id])
  inscriptions      Inscription[]
  sessions          WorkshopSession[]
  reports           Report[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([tenantId])
}

model WorkshopSession {
  id          String    @id @default(cuid())
  workshop    Workshop  @relation(fields: [workshopId], references: [id])
  workshopId  String
  dayOfWeek   Int
  timeStart   String
  timeEnd     String
  room        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Reservation {
  id            String    @id @default(cuid())
  displayId     String?
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  user          User      @relation(fields: [userId], references: [id])
  userId        String
  space         Space?    @relation(fields: [spaceId], references: [id])
  spaceId       String?
  equipment     Equipment? @relation(fields: [equipmentId], references: [id])
  equipmentId   String?
  cartSubmissionId String?
  project       Project?  @relation(fields: [projectId], references: [id])
  projectId     String?
  startTime     DateTime
  endTime       DateTime
  justification String
  subject       String?
  coordinator   String?
  teacher       String?
  status        ReservationStatus @default(PENDING)
  rejectionReason String?
  approvedByUserId String?
  approvedByUser   User?             @relation("ApprovedReservations", fields: [approvedByUserId], references: [id])
  checkedOutAt      DateTime?
  checkedOutByUserId String?
  checkedOutByUser   User?             @relation("CheckedOutReservations", fields: [checkedOutByUserId], references: [id])
  checkedInAt       DateTime?
  checkedInByUserId  String?
  checkedInByUser    User?             @relation("CheckedInReservations", fields: [checkedInByUserId], references: [id])
  documents     Document[]
  notifications Notification[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([tenantId])
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  PARTIALLY_APPROVED
}

enum InscriptionStatus {
  PENDING
  APPROVED
  REJECTED
  PENDING_EXTRAORDINARY
}

enum ResourceStatus {
  AVAILABLE
  IN_MAINTENANCE
}

enum ReportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

model Report {
  id          String        @id @default(cuid())
  reportIdCode String?      @unique
  description String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  status      ReportStatus  @default(OPEN)
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  space       Space?        @relation(fields: [spaceId], references: [id])
  spaceId     String?
  equipment   Equipment?    @relation(fields: [equipmentId], references: [id])
  equipmentId String?
  workshop    Workshop?     @relation(fields: [workshopId], references: [id])
  workshopId  String?
  user        User          @relation(fields: [userId], references: [id])
  userId      String
  comments    Comment[]
  
  @@index([tenantId])
}

model Comment {
  id        String   @id @default(cuid())
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  report    Report   @relation(fields: [reportId], references: [id])
  reportId  String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
}

model Document {
  id            String      @id @default(cuid())
  fileName      String
  filePath      String
  reservation   Reservation @relation(fields: [reservationId], references: [id])
  reservationId String
  createdAt     DateTime    @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  recipient User     @relation(fields: [recipientId], references: [id])
  recipientId String
  message   String
  read      Boolean  @default(false)
  reservation   Reservation? @relation(fields: [reservationId], references: [id])
  reservationId String?
  createdAt DateTime @default(now())
}

model Inscription {
  id          String    @id @default(cuid())
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  workshop    Workshop  @relation(fields: [workshopId], references: [id])
  workshopId  String
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  status      InscriptionStatus @default(PENDING)
  createdAt   DateTime  @default(now())

  @@unique([workshopId, userId])
  @@index([tenantId])
}

model ReservationCounter {
  id          String @id @default(cuid())
  date        String
  lastNumber  Int
  
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  tenantId           String
  
  @@unique([date, tenantId])
}

model SystemSettings {
  key   String @id
  value String
}

model Project {
  id          String  @id @default(cuid())
  name        String
  description String?
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  owner       User    @relation(fields: [ownerId], references: [id])
  ownerId     String
  reservations Reservation[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
}

model RecurringBlock {
  id                  String                      @id @default(cuid())
  title               String
  description         String?
  startDate           DateTime
  endDate             DateTime
  dayOfWeek           String
  startTime           String
  endTime             String
  
  tenant             Tenant?   @relation(fields: [tenantId], references: [id])
  tenantId           String?
  
  space               Space?                      @relation(fields: [spaceId], references: [id])
  spaceId             String?
  equipment           RecurringBlockOnEquipment[]
  exceptions          RecurringBlockException[]
  isVisibleToViewer   Boolean                     @default(true)
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt
  
  @@index([tenantId])
}

model RecurringBlockOnEquipment {
  recurringBlock   RecurringBlock @relation(fields: [recurringBlockId], references: [id])
  recurringBlockId String
  equipment        Equipment      @relation(fields: [equipmentId], references: [id])
  equipmentId      String

  @@id([recurringBlockId, equipmentId])
}

model RecurringBlockException {
  id                 String       @id @default(cuid())
  recurringBlock     RecurringBlock @relation(fields: [recurringBlockId], references: [id], onDelete: Cascade)
  recurringBlockId   String
  exceptionDate      DateTime
  exceptionStartTime String
  exceptionEndTime   String
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@unique([recurringBlockId, exceptionDate, exceptionStartTime, exceptionEndTime])
}

model Requirement {
  id     String  @id @default(cuid())
  name   String  @unique
  spaces Space[] @relation("SpaceRequirements")
}

model ReportCounter {
  id          String @id @default(cuid())
  date        String
  lastNumber  Int
  
  tenant             Tenant    @relation(fields: [tenantId], references: [id])
  tenantId           String
  
  @@unique([date, tenantId])
}

enum DomainStatus {
  NOT_CONFIGURED
  PENDING_DNS
  DNS_VERIFIED
  SSL_PENDING
  ACTIVE
  FAILED
}
